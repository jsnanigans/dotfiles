# Tmux Keybindings Configuration
# Separate file for better organization of all custom keybindings

# ============================================================================
# PANE NAVIGATION (vim-style)
# ============================================================================
# Pane navigation with prefix
bind -r h select-pane -L  # move left
bind -r j select-pane -D  # move down
bind -r k select-pane -U  # move up
bind -r l select-pane -R  # move right

# Alt + vim keys REMOVED - conflicts with AeroSpace window manager
# Using Ctrl-hjkl for smart pane switching instead (see below)

# Smart pane switching with awareness of Vim splits
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

# ============================================================================
# PANE MANAGEMENT
# ============================================================================
# Split panes
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -h -c "#{pane_current_path}"

# Resize panes with prefix
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# Resize panes with Shift+Arrow (no prefix needed)
bind-key -n S-Left resize-pane -L 2
bind-key -n S-Down resize-pane -D 2
bind-key -n S-Up resize-pane -U 2
bind-key -n S-Right resize-pane -R 2

# Swap panes
bind > swap-pane -D       # swap current pane with the next one
bind < swap-pane -U       # swap current pane with the previous one

# ============================================================================
# WINDOW NAVIGATION
# ============================================================================
# Window navigation
bind -r C-h previous-window # select previous window
bind -r C-l next-window     # select next window
bind Tab last-window        # move to last active window

# Quick window switching with Alt+number (no prefix needed)
bind-key -n M-1 select-window -t 1
bind-key -n M-2 select-window -t 2
bind-key -n M-3 select-window -t 3
bind-key -n M-4 select-window -t 4
bind-key -n M-5 select-window -t 5
bind-key -n M-6 select-window -t 6
bind-key -n M-7 select-window -t 7
bind-key -n M-8 select-window -t 8
bind-key -n M-9 select-window -t 9

# Cycle through windows with Alt+Space
bind-key -n M-Space next-window
bind-key -n M-S-Space previous-window

# ============================================================================
# SESSION MANAGEMENT
# ============================================================================
# Session navigation
bind BTab switch-client -l  # move to last session
bind C-c new-session
bind C-f command-prompt -p find-session 'switch-client -t %%'
bind C command-prompt -p "New session name:" "new-session -A -s '%%' -c '#{pane_current_path}'"

# Session/window sorting and filtering
bind s choose-tree -Zs -O name    # Sort sessions by name
bind w choose-tree -Zw -O name    # Sort windows by name

# ============================================================================
# COPY MODE
# ============================================================================
bind Enter copy-mode # enter copy mode

# Copy mode vi bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

# Copy mode navigation
bind -T copy-mode-vi 'C-h' select-pane -L
bind -T copy-mode-vi 'C-j' select-pane -D
bind -T copy-mode-vi 'C-k' select-pane -U
bind -T copy-mode-vi 'C-l' select-pane -R

# ============================================================================
# SEARCH & FILTER
# ============================================================================
# Custom search bindings
bind / copy-mode \; send-keys ?
bind ? copy-mode \; send-keys /

# FZF integration for better filtering
bind S display-popup -E "\
    tmux list-sessions -F '#{?session_attached,,#{session_name}}' |\
    sed '/^$/d' |\
    fzf --reverse --header 'Switch to session' |\
    xargs tmux switch-client -t"

bind W display-popup -E "\
    tmux list-windows -F '#I:#W' |\
    fzf --reverse --header 'Switch to window' |\
    cut -d: -f1 |\
    xargs tmux select-window -t"

# Extract text from pane
bind e run-shell "tmux split-window -h 'tmux capture-pane -t #{pane_id} -p | fzf --reverse | pbcopy'"

# ============================================================================
# MISC BINDINGS
# ============================================================================
# Configuration
bind e new-window -n "~/.tmux.conf.local" sh -c '${EDITOR:-vim} ~/.tmux.conf.local && tmux source ~/.tmux.conf && tmux display "~/.tmux.conf sourced"'
bind r source-file ~/.tmux.conf \; display '~/.tmux.conf sourced'

# Clear both screen and history
bind -n C-l send-keys C-l \; run 'sleep 0.2' \; clear-history

# Toggle mouse
bind m run "cut -c3- ~/.tmux.conf | sh -s _toggle_mouse"

# Show keybindings help
bind ? display-popup -E -w 82 -h 40 "fish -c 'tmux-help | less'"
bind C-h display-popup -E -w 80% -h 80% "fish -c 'tmux-keys'"

# Maximize current pane
bind + run 'cut -c3- ~/.tmux.conf | sh -s _maximize_pane "#{session_name}" #D'

# URL view
bind U run "cut -c3- ~/.tmux.conf | sh -s _urlview #{pane_id}"

# Facebook PathPicker
bind F run "cut -c3- ~/.tmux.conf | sh -s _fpp #{pane_id} #{pane_current_path}"

# Quick session switching (unified session manager)
bind-key -r f display-popup -E -w 80% -h 80% "fish -c 'session project'"

# Buffers
bind b list-buffers  # list paste buffers
bind p paste-buffer  # paste from the top paste buffer
bind P choose-buffer # choose which buffer to paste from